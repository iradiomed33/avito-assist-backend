 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/app/main.py b/app/main.py
index f4ef7f68814dea1cb555beb7a375bdcdd3f1017f..7e334465d062fb153a5eb457549492f2674308be 100644
--- a/app/main.py
+++ b/app/main.py
@@ -1,38 +1,38 @@
 import os
 import requests
 from fastapi import FastAPI, status, HTTPException, Form, Depends, Request
 from app.schemas_avito import AvitoWebhook
 from app.clients.perplexity_client import PerplexityClient, PerplexityClientError
 from app.clients.stt_client import STTClient, STTClientError
 from app.token_store import AvitoTokenStore, AvitoTokens
 from fastapi.responses import RedirectResponse, HTMLResponse
 from app.clients.avito_client import AvitoMessengerClient, AvitoClientError
 from app.settings import avito_settings
 from app.clients.avito_auth_client import AvitoAuthClient, AvitoAuthError
 import logging
-from app.projects.models import Project
+from app.projects.models import Project, TimeRange
 from app.projects.store import ProjectStore
 from typing import List
 from datetime import datetime
 import zoneinfo
 from fastapi.templating import Jinja2Templates
 from fastapi.staticfiles import StaticFiles
 from fastapi.security import HTTPBasic, HTTPBasicCredentials
 import secrets
 from app.avito_item_client import AvitoItemClient
 from app.prompts import build_system_prompt
 from datetime import timezone
 from app.error_handlers import (
     http_exception_handler,
     validation_exception_handler,
     generic_exception_handler,
 )
 from app.middleware import RequestLoggingMiddleware
 from app.logging_config import setup_logging
 from fastapi.exceptions import RequestValidationError
 from starlette.exceptions import HTTPException as StarletteHTTPException
 from dotenv import load_dotenv
 from app.chat_state import ChatState
 from apscheduler.schedulers.asyncio import AsyncIOScheduler
 
 load_dotenv()
@@ -48,79 +48,112 @@ setup_logging(
     log_file="logs/avito-assist.log",  # ÐžÐ¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾
 )
 logger = logging.getLogger("avito-assist")
 
 
 app = FastAPI(title="Avito Assist Backend", version="0.1.0")
 
 app.add_middleware(RequestLoggingMiddleware)
 
 # ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ error handlers
 app.add_exception_handler(StarletteHTTPException, http_exception_handler)
 app.add_exception_handler(RequestValidationError, validation_exception_handler)
 app.add_exception_handler(Exception, generic_exception_handler)
 
 templates = Jinja2Templates(directory="templates")
 app.mount("/static", StaticFiles(directory="static"), name="static")
 
 # ÐšÐ»Ð¸ÐµÐ½Ñ‚Ñ‹ Ð²Ð½ÐµÑˆÐ½Ð¸Ñ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð² Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ð´Ð¸Ð½ Ñ€Ð°Ð· Ð¿Ñ€Ð¸ ÑÑ‚Ð°Ñ€Ñ‚Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
 perplexity_client = PerplexityClient()
 stt_client = STTClient()
 avito_auth_client = AvitoAuthClient()
 avito_messenger_client = AvitoMessengerClient(base_url=avito_settings.avito_api_base_url)
 avito_token_store = AvitoTokenStore()
 project_store = ProjectStore()
 chat_state = ChatState()
-avito_messenger_client = AvitoMessengerClient()
 
 
 async def avito_auto_poller():
     """ÐŸÐ¾Ð»Ð»ÐµÑ€: Ñ‡Ð°Ñ‚Ñ‹ â†’ Perplexity â†’ Ð°Ð²Ñ‚Ð¾Ð¾Ñ‚Ð²ÐµÑ‚ ÐºÐ°Ð¶Ð´Ñ‹Ðµ 30 ÑÐµÐº"""
     try:
         tokens = avito_token_store.get_default_tokens()
-        chats = avito_messenger_client.get_chats(tokens.access_token, unread_only=True)
-        
+        if not tokens:
+            logger.warning("ÐÐµÑ‚ ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½Ð½Ñ‹Ñ… Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð² Avito â€” Ð¿Ð¾Ð»Ð»ÐµÑ€ Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Ð¸Ñ‚ÐµÑ€Ð°Ñ†Ð¸ÑŽ")
+            return
+
+        account_id = tokens.account_id
+        if not account_id:
+            account_info = avito_messenger_client.get_account_info(tokens.access_token)
+            account_id = str(account_info.get("id")) if account_info else None
+            tokens.account_id = account_id
+            avito_token_store.save_default_tokens(tokens)
+
+        if not account_id:
+            logger.error("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ account_id Avito, Ð¿Ð¾Ð»Ð»ÐµÑ€ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð½Ð° Ð¸Ñ‚ÐµÑ€Ð°Ñ†Ð¸Ð¸")
+            return
+
+        chats = avito_messenger_client.get_chats(
+            access_token=tokens.access_token,
+            account_id=account_id,
+            unread_only=True,
+        )
+
+        project = project_store.get_project("default")
+        system_prompt = build_system_prompt(project, item_context="") if project else ""
+
         for chat in chats[:3]:  # 3 Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ñ‡Ð°Ñ‚Ð°
-            chat_id = chat["id"]
-            messages = avito_messenger_client.get_messages(tokens.access_token, chat_id, limit=3)
-            
+            chat_id = chat.get("id")
+            messages = avito_messenger_client.get_chat_messages(
+                chat_id=chat_id,
+                access_token=tokens.access_token,
+                limit=3,
+            )
+
             # ÐŸÐ¾ÑÐ»ÐµÐ´Ð½ÐµÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° (direction="in")
-            last_client_msg = next((m for m in reversed(messages) if m.get("direction") == "in"), None)
+            last_client_msg = next(
+                (m for m in reversed(messages) if getattr(m, "direction", m.get("direction")) == "in"),
+                None,
+            )
             if last_client_msg:
-                client_text = last_client_msg["content"]["text"]
+                content = getattr(last_client_msg, "content", last_client_msg.get("content", {}))
+                client_text = content.get("text")
+                if not client_text:
+                    continue
                 logger.info(f"ÐÐ¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð² {chat_id}: {client_text}")
-                
-                # Perplexity Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ Ð¾Ñ‚Ð²ÐµÑ‚
-                ai_response = await perplexity_ask(f"ÐšÐ»Ð¸ÐµÐ½Ñ‚: {client_text}\nÐžÑ‚Ð²ÐµÑ‚ÑŒ ÐºÐ°Ðº Ð¿Ñ€Ð¾Ð´Ð°Ð²ÐµÑ† Ñ‚ÐµÐ»ÐµÑÐºÐ¾Ð¿Ð¾Ð²:")
-                
-                # ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼!
-                result = avito_messenger_client.send_text(tokens.access_token, chat_id, ai_response)
+
+                ai_response = perplexity_client.generate_reply(
+                    user_message=client_text,
+                    system_prompt=system_prompt or "ÐžÑ‚Ð²ÐµÑ‚ÑŒ ÐºÐ°Ðº Ð¿Ñ€Ð¾Ð´Ð°Ð²ÐµÑ† Ñ‚ÐµÐ»ÐµÑÐºÐ¾Ð¿Ð¾Ð²",
+                )
+
+                avito_messenger_client.send_text_message(
+                    chat_id=chat_id,
+                    text=ai_response,
+                    access_token=tokens.access_token,
+                )
                 logger.info(f"âœ… ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½ Ð°Ð²Ñ‚Ð¾Ð¾Ñ‚Ð²ÐµÑ‚: {ai_response}")
-                
-                # ÐŸÐ¾Ð¼ÐµÑ‡Ð°ÐµÐ¼ Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ‹Ð¼
-                avito_messenger_client.mark_read(tokens.access_token, chat_id)
-                
+
     except Exception as e:
         logger.error(f"ÐŸÐ¾Ð»Ð»ÐµÑ€ Ð¾ÑˆÐ¸Ð±ÐºÐ°: {e}")
 
 # Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸ ÑÑ‚Ð°Ñ€Ñ‚Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
 @app.on_event("startup")
 async def startup_scheduler():
     scheduler = AsyncIOScheduler()
     scheduler.add_job(avito_auto_poller, "interval", seconds=30)
     scheduler.start()
     logger.info("ðŸš€ ÐÐ²Ñ‚Ð¾Ð¾Ñ‚Ð²ÐµÑ‚Ñ‡Ð¸Ðº Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½! ÐšÐ°Ð¶Ð´Ñ‹Ðµ 30 ÑÐµÐº")
 
 def _is_within_schedule(project: Project, now_utc: datetime) -> bool:
     """
     ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚, Ð¿Ð¾Ð¿Ð°Ð´Ð°ÐµÑ‚ Ð»Ð¸ Ñ‚ÐµÐºÑƒÑ‰ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ Ð² Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ðµ Ð¸Ð½Ñ‚ÐµÑ€Ð²Ð°Ð»Ñ‹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°.
     """
     if project.schedule_mode == "always":
         return True
 
     tz = zoneinfo.ZoneInfo(project.timezone)
     now_local = now_utc.astimezone(tz)
     weekday = now_local.weekday()  # 0=Mon ... 6=Sun
     time_str = now_local.strftime("%H:%M")
 
     day_map = {
         0: project.schedule.mon,
@@ -164,58 +197,65 @@ async def health_check():
 @app.post(
     "/webhooks/avito",
     status_code=status.HTTP_200_OK,
     summary="Avito Messenger webhook endpoint",
 )
 async def avito_webhook_handler(webhook: AvitoWebhook):
     logger.info(
         "Received Avito webhook: id=%s type=%s chat_id=%s",
         webhook.id,
         webhook.payload.type,
         webhook.payload.value.chat_id,
     )
 
     project = project_store.get_project("default")
     if not project:
         logger.error("No default project configured, skipping webhook")
         return {
             "processed": False,
             "reason": "no_project",
             "stt_error": None,
             "assistant_error": None,
             "messaging_error": None,
         }
 
     now_utc = datetime.now(timezone.utc)
-    if not project.enabled or not _is_within_schedule(project, now_utc):
-        logger.info(
-            "Assistant disabled or out of schedule for project=%s, skipping",
-            project.id,
-        )
+    if not project.enabled:
+        logger.info("Assistant disabled for project=%s, skipping", project.id)
         return {
             "processed": False,
-            "reason": "no_project",
+            "reason": "disabled",
+            "stt_error": None,
+            "assistant_error": None,
+            "messaging_error": None,
+        }
+
+    if not _is_within_schedule(project, now_utc):
+        logger.info("Assistant out of schedule for project=%s, skipping", project.id)
+        return {
+            "processed": False,
+            "reason": "out_of_schedule",
             "stt_error": None,
             "assistant_error": None,
             "messaging_error": None,
         }
      # ÐŸÐ¾ÐºÐ° Ð½Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ context â€” Ð±ÑƒÐ´ÐµÐ¼ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÑ‚ÑŒ Ð¿Ð¾Ð·Ð¶Ðµ, ÐºÐ¾Ð³Ð´Ð° ÐÐ²Ð¸Ñ‚Ð¾ Ð¾Ð´Ð¾Ð±Ñ€Ð¸Ñ‚ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
     item_context_str = ""
     author_id = webhook.payload.value.author_id
     original_message_type = webhook.payload.value.type
     content = webhook.payload.value.content
     chat_id = webhook.payload.value.chat_id
 
     # Ð˜ÑÑ…Ð¾Ð´Ð½Ñ‹Ð¹ Ñ‚ÐµÐºÑÑ‚ Ð¸Ð· Avito (Ð´Ð»Ñ text-ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹)
     message_text = content.text
 
     assistant_reply: str | None = None
     assistant_error: str | None = None
     stt_error: str | None = None
     messaging_error: str | None = None
     recognized_text: str | None = None
 
     # ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹: ÑÐ½Ð°Ñ‡Ð°Ð»Ð° Ñ€Ð°ÑÐ¿Ð¾Ð·Ð½Ð°Ñ‘Ð¼ Ñ€ÐµÑ‡ÑŒ
     if original_message_type == "voice" and content.audio_url:
         try:
             recognized_text = stt_client.transcribe(content.audio_url)
             # ÐŸÐ¾ÑÐ»Ðµ Ñ€Ð°ÑÐ¿Ð¾Ð·Ð½Ð°Ð²Ð°Ð½Ð¸Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ñ‚ÐµÐºÑÑ‚ ÐºÐ°Ðº Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
@@ -293,67 +333,67 @@ async def avito_oauth_start():
         f"?response_type=code"
         f"&client_id={client_id}"
         f"&scope={scope}"
         f"&redirect_uri={redirect_uri}"
     )
 
     return RedirectResponse(url=auth_url)
 
 
 
 @app.get("/avito/oauth/callback")
 async def avito_oauth_callback(code: str | None = None, error: str | None = None):
     """
     Callback-ÑÐ½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚ Ð´Ð»Ñ Ð¿Ñ€Ð¸Ñ‘Ð¼Ð° authorization_code Ð¾Ñ‚ ÐÐ²Ð¸Ñ‚Ð¾.
 
     - ÐŸÑ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ HTTP 400;
     - ÐŸÑ€Ð¸ ÑƒÑÐ¿ÐµÑ…Ðµ Ð¾Ð±Ð¼ÐµÐ½Ð¸Ð²Ð°ÐµÑ‚ code Ð½Ð° access/refresh Ñ‚Ð¾ÐºÐµÐ½Ñ‹.
     """
     if error:
         raise HTTPException(status_code=400, detail=f"Avito auth error: {error}")
     if not code:
         raise HTTPException(status_code=400, detail="Missing authorization code")
 
     try:
         tokens = avito_auth_client.exchange_code_for_tokens(code)
-            # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ‚Ð¾ÐºÐµÐ½Ñ‹ Ð² Ñ„Ð°Ð¹Ð»Ð¾Ð²Ð¾Ð¼ Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ ÐºÐ°Ðº "default"
         avito_tokens = AvitoTokens.from_oauth_response(tokens)
+        # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ‚Ð¾ÐºÐµÐ½Ñ‹ Ð² Ñ„Ð°Ð¹Ð»Ð¾Ð²Ð¾Ð¼ Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ ÐºÐ°Ðº "default"
+        try:
+            account_info = avito_messenger_client.get_account_info(avito_tokens.access_token)
+            avito_tokens.account_id = str(account_info.get("id")) if account_info else None
+        except AvitoClientError as exc:
+            logger.warning("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ account_id Ñƒ Avito: %s", exc)
+
         avito_token_store.save_default_tokens(avito_tokens)
 
     except AvitoAuthError as exc:
         raise HTTPException(status_code=502, detail=str(exc))
 
     return RedirectResponse(url="/ui/project", status_code=303)
 
 security = HTTPBasic()
 
-ADMIN_USERNAME = os.getenv("ADMIN_USERNAME", "admin")
-ADMIN_PASSWORD = os.getenv("ADMIN_PASSWORD", "changeme")  # Ð¿Ð¾Ñ‚Ð¾Ð¼ Ð²Ñ‹Ð½ÐµÑÐµÐ¼ Ð² .env
-
-if not ADMIN_PASSWORD:
-    raise ValueError("ADMIN_PASSWORD must be set in .env file!")
-
 
 def get_current_admin(credentials: HTTPBasicCredentials = Depends(security)) -> str:
     correct_username = secrets.compare_digest(credentials.username, ADMIN_USERNAME)
     correct_password = secrets.compare_digest(credentials.password, ADMIN_PASSWORD)
     if not (correct_username and correct_password):
         raise HTTPException(
             status_code=401,
             detail="Invalid credentials",
             headers={"WWW-Authenticate": "Basic"},
         )
     return credentials.username
 
 
 @app.get("/admin/projects", response_model=List[Project])
 def list_projects(current_admin: str = Depends(get_current_admin)):
     return project_store.list_projects()
 
 
 @app.get("/admin/projects/{project_id}", response_model=Project)
 def get_project(project_id: str, current_admin: str = Depends(get_current_admin)):
     project = project_store.get_project(project_id)
     if not project:
         raise HTTPException(status_code=404, detail="Project not found")
     return project
 
@@ -377,64 +417,78 @@ async def debug_avito_self(current_admin: str = Depends(get_current_admin)):
     tokens = avito_token_store.get_default_tokens()
     if not tokens:
         raise HTTPException(status_code=404, detail="No Avito tokens found")
     
     url = f"{avito_settings.avito_api_base_url}/core/v1/accounts/self"
     headers = {
         "Authorization": f"Bearer {tokens.access_token}",
     }
     
     try:
         resp = requests.get(url, headers=headers, timeout=10)
         return {
             "status": "ok",
             "status_code": resp.status_code,
             "response": resp.json() if resp.status_code == 200 else resp.text,
             "expires_at": tokens.expires_at.isoformat(),
         }
     except Exception as exc:
         logger.exception("Failed to call Avito /core/v1/accounts/self")
         raise HTTPException(status_code=502, detail=str(exc))
 
 # Debug endpoint
 @app.get("/admin/debug/chats")
 async def debug_chats(current_admin: str = Depends(get_current_admin)):
     tokens = avito_token_store.get_default_tokens()
-    chats = avito_messenger_client.get_chats(tokens.access_token, limit=5)
-    return {"user_id": avito_messenger_client.user_id, "chats": chats}
+    if not tokens or not tokens.account_id:
+        raise HTTPException(status_code=404, detail="No Avito account id saved")
+    chats = avito_messenger_client.get_chats(
+        access_token=tokens.access_token,
+        account_id=tokens.account_id,
+        limit=5,
+    )
+    return {"account_id": tokens.account_id, "chats": chats}
 
 @app.get("/admin/debug/chat/{chat_id}/messages")
 async def debug_chat_messages(chat_id: str, current_admin: str = Depends(get_current_admin)):
     tokens = avito_token_store.get_default_tokens()
-    messages = avito_messenger_client.get_messages(tokens.access_token, chat_id, limit=5)
+    messages = avito_messenger_client.get_chat_messages(
+        chat_id=chat_id,
+        access_token=tokens.access_token,
+        limit=5,
+    )
     return {"chat_id": chat_id, "messages": messages[:3]}
 
 @app.post("/admin/debug/chat/{chat_id}/send")
 async def debug_send_message(chat_id: str, text: str, current_admin: str = Depends(get_current_admin)):
     tokens = avito_token_store.get_default_tokens()
-    result = avito_messenger_client.send_text(tokens.access_token, chat_id, text)
-    return {"sent": result}
+    avito_messenger_client.send_text_message(
+        chat_id=chat_id,
+        text=text,
+        access_token=tokens.access_token,
+    )
+    return {"sent": True}
 
 
 @app.get("/ui/project", response_class=HTMLResponse)
 async def ui_get_project(
     request: Request,
     current_admin: str = Depends(get_current_admin),
 ):
     project = project_store.get_project("default")
     return templates.TemplateResponse(
         "project.html",
         {
             "request": request,
             "project": project,
         },
     )
 
 
 
 @app.post("/ui/project")
 async def ui_update_project(
     request: Request,
     id: str = Form(...),
     name: str = Form(...),
     business_type: str = Form(...),
     timezone: str = Form(...),
 
EOF
)